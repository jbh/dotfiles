#!/bin/bash

# Currently only handles openforti vpns
ofv_path="$HOME/.config/openfortivpn"
oc_path="$HOME/.config/openconnect"
ofv_options=$(ls -1 "$ofv_path")
oc_options=$(ls -1 "$oc_path")
options=$(echo "$ofv_options" && echo "$oc_options" && echo -e "quit")

choice=$(echo -e "${options[@]}" | dmenu -i -p 'Open VPN: ')

[[ ! ${options[*]} =~ (^|[[:space:]])"$choice"($|[[:space:]]) ]] && echo "Program terminated." && exit 1

if [[ ${ofv_options[*]} =~ (^|[[:space:]])"$choice"($|[[:space:]]) ]]; then
  st -c st-vpn -t "VPN - $choice" -e sudo openfortivpn -c "$ofv_path/$choice"
fi

if [[ ${oc_options[*]} =~ (^|[[:space:]])"$choice"($|[[:space:]]) ]]; then
  config="$oc_path/$choice"
  configbak="$config.bak"

  source $config
  sed -i.bak '/passwd/d;/host/d' $config

  connect="echo $passwd | sudo openconnect --config=$config --passwd-on-stdin $host && "
  connect+="rm $config && mv $configbak $config"

  st -c st-vpn -t "VPN - $choice" -e sh -c "$connect"
fi

