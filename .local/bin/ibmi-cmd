#!/bin/bash
# Run a remote command on IBM i
#
set -e

usage() {
    SCRIPT="$(basename -- $0)"
    echo -e "\
Usage:\t$SCRIPT [options]
Run a remote command on IBM i

OPTIONS
  -h, --help     Display this help text
  -s, --server   VPN software to use                        **required**
  -u, --user     User for VPN                               **required**
  -c, --cmd      IP to ping to validate VPN connection      **required**"
}

print_cli_error() {
    echo -e "\e[31m$1\n\e[39m"
    usage
    exit 1
}

readonly SHORTOPTS=:hs:u:c:
readonly LONGOPTS=help,server:,user:,cmd:
readonly OPTS=$(getopt --options $SHORTOPTS --long $LONGOPTS --name "$0" -- "$@")

eval set -- "$OPTS"

while true; do
    case "$1" in
        -h | --help)
            usage
            exit
            ;;
        -s | --server)
            SERVER=$2
            shift 2
            ;;
        -u | --user)
            USER=$2
            shift 2
            ;;
        -c | --cmd)
            COMMAND=$2
            shift 2
            ;;
        --)
            shift
            break
            ;;
        *)
            print_cli_error "ERROR: Unknown parameter \"$PARAM\""
            ;;
    esac
done

if [[ -z "$SERVER" || -z "$USER" || -z "$COMMAND" ]]; then
    ERROR="ERROR: Missing required options"
    REQUIRED="[-s,--server] [-u,--user] [-c,--cmd]"
    print_cli_error "$ERROR\nRequired options: $REQUIRED"
fi

echo -n "Password: "
read -s PASSWORD
echo

(printf "$USER"; sleep 1; printf "\t$PASSWORD\r\n"; sleep 1; printf "\r\n"; sleep 1; printf "$COMMAND\r\n"; sleep 1;) | \
    telnet $SERVER

